# Copyright (c) 2023 by Michael Arsollon
# derived from original game at https://github.com/endless-sky/endless-sky
#
# Endless Sky is free software: you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later version.
#
# Endless Sky is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE.  See the GNU General Public License for more details.



mission "Midnight Expansion: Add Fuel Stabilizer"
	landing
	invisible
	on offer
		event "add fuel stabilizer"
		set "fuel stabilizer sales patched"
		fail

event "add fuel stabilizer"
	outfitter "Advanced Fuel"
		add "Fuel Stabilizer"

mission "Midnight Expansion: Add Fuel Stabilizer Patch"
	landing
	invisible
	to offer
		has "Midnight Expansion: Add Fuel Stabilizer: failed"
		not "fuel stabilizer sales patched"
	on offer
		event "add fuel stabilizer"
		set "fuel stabilizer sales patched"
		fail


mission "Midnight Expansion: Add Garbage Scows"
	landing
	invisible
	on offer
		event "add garbage scows"
		set "added ccor garbage scows"
		fail

event "add garbage scows"
	shipyard "Advanced Northern Pirates"
		add "Garbage Scow"
	shipyard "Advanced Core Pirates"
		add "Garbage Scow"
	shipyard "Advanced Southern Pirates"
		add "Garbage Scow"
	fleet "Large Northern Merchants"
		add variant 1
			"Garbage Scow"
	fleet "Large Core Merchants"
		add variant 1
			"Garbage Scow"
	fleet "Large Southern Merchants"
		add variant 1
			"Garbage Scow (Jammer)"
	fleet "Large Dirt Belt Pirates"
		add variant 1
			"Garbage Scow (Turbo)"
		add variant 1
			"Modified Garbage Scow"
			"Rancor (Turbo Blaster)" 2
	fleet "Large CCOR"
		add variant 1
			"Garbage Scow (Stinger)"
		add variant 1
			"Modified Garbage Scow (Quad Blaster)"
			"Berserker (Limit Break)" 2
	fleet "pirate raid"
		add variant 1
			"Garbage Scow (Stinger)"
	fleet "pirate raid (rivals)"
		add variant 1
			"Garbage Scow (Stinger)"
	fleet "Large Independent"
		add variant 1
			"Garbage Scow (Stinger)"

mission "Midnight Expansion: Add CCOR Garbage Scows"
	landing
	invisible
	to offer
		has "event: add garbage scows"
		not "added ccor garbage scows"
	on offer
		event "add ccor garbage scows"
		fail

event "add ccor garbage scows"
	fleet "Large CCOR"
		add variant 1
			"Garbage Scow (Stinger)"
		add variant 1
			"Modified Garbage Scow (Quad Blaster)"
			"Berserker (Limit Break)" 2

mission "Midnight Expansion: Update Garbage Scows"
	landing
	invisible
	to offer
		has "event: war begins"
	on offer
		event "update garbage scows"
		set "added raid modified garbage scows"
		fail

event "update garbage scows"
	shipyard "Common Freighters"
		add "Garbage Scow"
	shipyard "Dirt Belt Pirates"
		add "Modified Garbage Scow (Quad Blaster)"
	shipyard "Advanced Northern Pirates"
		remove "Garbage Scow"
		add "Modified Garbage Scow (Quad Blaster)"
	shipyard "Advanced Core Pirates"
		remove "Garbage Scow"
		add "Modified Garbage Scow (Quad Blaster)"
	shipyard "Advanced Southern Pirates"
		remove "Garbage Scow (Jammer)"
		add "Modified Garbage Scow (Quad Blaster)"
	fleet "Large Northern Pirates"
		add variant 1
			"Garbage Scow (Heavy)"
		add variant 1
			"Modified Garbage Scow (Heavy)"
			"Berserker (Strike Limit Break)" 2
	fleet "Large Core Pirates"
		add variant 1
			"Garbage Scow (Proton)"
		add variant 1
			"Modified Garbage Scow (Proton)"
			"Stingray (Proton)" 2
	fleet "Large Southern Pirates"
		add variant 1
			"Garbage Scow (Quad Blaster)"
		add variant 1
			"Modified Garbage Scow (Quad Blaster)"
			"Hawk (Stinger)" 2
	fleet "pirate raid"
		add variant 1
			"Modified Garbage Scow (Quad Blaster)"
	fleet "pirate raid (rivals)"
		add variant 1
			"Modified Garbage Scow (Quad Blaster)"

mission "Midnight Expansion: Add Raid Modified Garbage Scows"
	landing
	invisible
	to offer
		has "event: update garbage scows"
		not "added raid modified garbage scows"
	on offer
		event "add raid modified garbage scows"
		fail

event "add raid modified garbage scows"
	fleet "pirate raid"
		add variant 1
			"Modified Garbage Scow (Quad Blaster)"
	fleet "pirate raid (rivals)"
		add variant 1
			"Modified Garbage Scow (Quad Blaster)"



mission "Midnight Expansion: Bounty Hunting (Boarding, Stinger Missile)"
	assisting
	repeat
	name "Wanted smuggler near <system>"
	description "A low-end pirate smuggler named the <npc> has been supplying pirate planets with weapons near the <system> system. Destroy it and report to <planet> for payment (<payment>)."
	to offer
		"combat rating" > 300
		random < 3 - "Midnight Expansion: Bounty Hunting (Boarding, Stinger Missile): offered"
	source
		government "Republic" "Free Worlds" "Syndicate" "Militia" "Navy (Oathkeeper)"
		not category "Fighter" "Drone"
		not attributes "automaton"
	destination
		government "Republic" "Free Worlds" "Syndicate" "Neutral" "Independent"
		attributes "frontier"
		distance 1 2
	on offer
		conversation
			`The captain of the <origin> thanks you for repairing them and informs you that they were searching for a smuggler ship named the <npc> that is supplying weapons to nearby pirate planets.`
			`	The authorities of <planet> will probably pay you quite well if you hunt down the <npc>, but depending on how quickly you are able to track it down, this could require more than a short detour.`
			choice
				`	(Hunt the <npc>.)`
					accept
				`	(Ignore this opportunity.)`
					decline
	npc kill
		government "Bounty"
		personality heroic staying nemesis target
		system
			distance 1
		fleet
			names "pirate"
			cargo 1
			outfitters "Stinger Missile"
			variant
				"Garbage Scow (Stinger)"

		dialog phrase "generic hunted bounty eliminated dialog"
	on visit
		dialog phrase "generic bounty hunting on visit"
	on complete
		payment 150000
		dialog phrase "generic bounty hunting payment dialog"

mission "Midnight Expansion: Bounty Hunting (Smuggler, Disguised)"
	job
	repeat
	name "Disguised pirate near <system>"
	description "A pirate smuggler named the <npc> is posing as a merchant ship near the <system> system. Select merchant ships until you find a ship with a matching name, then destroy it and return to <planet> for payment (<payment>)."
	to offer
		"combat rating" > 400
		random < 5
	source
		government "Republic" "Free Worlds" "Syndicate" "Neutral" "Independent"
		attributes "rim" "south" "north" "dirt belt" "core" "frontier"
	npc kill
		government "Bounty (Disguised)"
		personality heroic staying
		system
			distance 1 2
		fleet
			names "pirate"
			cargo 1
			outfitters "Contraband"
			variant
				"Garbage Scow (Stinger)"
			variant
				"Modified Firebird (Smuggler)"
		dialog phrase "generic hunted bounty eliminated dialog"
	on visit
		dialog phrase "generic bounty hunting on visit"
	on complete
		payment 350000
		dialog phrase "generic bounty hunting payment dialog"

mission "Midnight Expansion Cargo Trap (Core)"
	name "Convoy near <system>"
	job
	repeat
	description `A merchant convoy has been spotted near the <system> system. A local warlord is interested in having the cargo on the <npc>. Plunder it and return to <planet> by <day> for payment of <payment>.`
	to offer
		or
			has "fw delivered prisoners"
			has "main plot completed"
		random < 5
		"combat rating" > 3500
	deadline 20
	source
		government Pirate
		attributes "core pirate"
	npc
		government "Merchant"
		personality staying heroic target
		system
			not government "Pirate"
			distance 2 2
		fleet
			names "civilian"
			variant
				"Bulk Freighter (Secret Cargo) "
				"Locust" 12
				"Quicksilver (Proton)" 6
			variant
				"Bulk Freighter (Secret Cargo) "
				"Locust" 12
				"Vanguard"
				"Splinter (Proton)"
			variant
				"Bulk Freighter (Secret Cargo) "
				"Locust" 12
				"Protector (Proton)"
				"Manta (Proton)"
	on visit
		dialog "You land on <planet>, but you don't have the secret cargo! Return to the <npc> and bring the cargo back to <planet>."
	on complete
		outfit "Secret Cargo" -1
		payment 1500000
		dialog "The pirates of <planet> take the secret cargo from your cargo hold and pay you <payment>."

mission "Midnight Expansion: Recycle garbage"
	name "Recycle garbage"
	description "<origin> produces a lot of garbage that needs to be disposed of off-station. Transport <cargo> to the industrial solid waste recycler on <destination>. Payment is <payment>."
	job
	repeat
	to offer
		random < 35
	cargo "Garbage" 100 185
	source
		government "Republic" "Syndicate" "Free Worlds" "Pirate" "Independent" "Neutral"
		attributes station
	destination
		attributes "factory" "mining" "dirt belt"
		distance 9 12
	npc
		government "Pirate"
		system destination
		personality waiting staying plunders harvests
		fleet
			names "pirate"
			cargo 0
			variant
				"Garbage Scow (Stinger)"
			variant
				"Garbage Scow (Heavy)"
	on visit
		dialog phrase "generic cargo on visit"
	on complete
		dialog "You drop off the <commodity> at an especially smelly solid waste recycler and collect your payment of <payment>."
		payment
		payment 40000

mission "Midnight Expansion: Waste Disposal"
	name "Waste disposal on <planet>"
	job
	repeat
	description "Urgent waste disposal is needed. Transport <cargo> to <destination> to keep property values from falling. Payment is <payment>."
	cargo "Garbage" 6 40
	to offer
		random < 5
	on offer
		require "Radiological Containment"
	source
		attributes "paradise"
	destination
		distance 2 20
		attributes "dirt belt"
	npc
		government "Pirate"
		system destination
		personality waiting staying plunders harvests
		fleet
			names "pirate"
			cargo 0
			variant
				"Garbage Scow (Stinger)"
			variant
				"Garbage Scow (Turbo)"
	on visit
		dialog phrase "generic cargo on visit"
	on complete
		payment
		payment 2000
		dialog "You drop off the exceptionally foul shipment of <commodity> on <planet>, already looking forward to the chemical bath your cargo hold is going to receive. You collect your payment of <payment> and hope that somebody around here knows what to do with the unpleasant mess you dropped off."

mission "Midnight Expansion: Waste recycling on <planet>"
	job
	repeat
	name "Waste recycling on <planet>"
	description "Syndicated Systems is looking for intrepid captains willing to make a difference as part of our new Green Initiative! Deliver <tons> of recyclable <commodity> to our special facility on <destination>. Payment is <payment>."
	cargo "Garbage" 15 100
	to offer
		random < 10
	on offer
		require "Radiological Containment"
	source
		government Syndicate
	destination
		distance 3 10
		government Syndicate
	npc
		government "Pirate"
		system destination
		personality waiting staying plunders harvests
		fleet
			names "pirate"
			cargo 0
			variant
				"Garbage Scow (Stinger)"
			variant
				"Garbage Scow (Proton)"
	on visit
		dialog phrase "generic cargo on visit"
	on complete
		payment
		payment 20000
		dialog "You land on <planet> and drop off the exceptionally smelly shipment of <commodity> at a nondescript building, as instructed. Just as you take off, your rear camera catches sight of a burly Syndicate employee running out of the building shaking his fist. You notice that your payment of <payment> came from your contact on <origin>, not from anywhere on <planet>."

mission "Midnight Expansion: Garbage Escort (Double Cross)"
	minor
	name "Garbage Escort"
	description "Escort the <npc> through a dangerous region of space to the industrial solid waste recycler on <destination>. Payment is 20,000 credits."
	to offer
		"combat rating" > 300
		or
			and
				not "Randomize Midnight Expansion: Garbage Escort (Double Cross)"
				random < 70
			and
				has "Randomize Midnight Expansion: Garbage Escort (Double Cross)"
				random < 5
	source
		attributes station
	destination
		attributes "frontier"
		distance 9 12
	on offer
		conversation
			scene "thumbnail/Becca scavenger"
			`The captain of a Garbage Scow docked nearby waves at you.`
			choice
				`	(Wave back.)`
				`	(Ignore him.)`
					defer
			`	The captain approaches. As he does, you notice the odor of rotting garbage precedes him. "I'm sorry to ask this, but I'm in need of an escort. It turns out that pirates find value in the toxic waste I'm hauling. It's a necessary component for certain dirty weapons. If you could escort my ship, the <npc>, to the industrial solid waste recycler on <destination>, I'd be willing to pay 20,000 credits for your assistance. How about it?`
			`	Escorting a Garbage Scow isn't what you imagined you'd be doing when you dreamed of exploring the stars. But you could help prevent dangerous material from falling into pirate hands. What do you do?`
			choice
				`	(Escort the <npc>.)`
				`	(Refuse.)`
					decline
			`	"Great! The name's Geryon." He wipes a grime covered hand on his overalls before extending it to you.`
			choice
				`	(Shake his hand.)`
				`	(Don't shake his hand.)`
					goto hanging
			`	"<first>," you reply.`
			`	Geryon smirks. "I'll be waiting in orbit!" He walks off. The foul stench remains...`
				accept
			label hanging
			`	"<first>," you reply.`
			`	After an awkward moment, Geryon lowers his hand. "Well, I'll be waiting in orbit." He walks off. The foul stench remains...`
				accept
	on defer
		set "Randomize Midnight Expansion: Garbage Escort (Double Cross)"
	on accept
		log "Minor People" "Geryon" `Geryon is the captain of a Garbage Scow, hauling dangerous toxic waste across the galaxy. He's worried that pirates will target his ship to get their hands on his cargo. Supposedly, it can be used to make dirty weapons.`
		"reputation: Bounty (Disguised)" >?= 1	
	on enter
	on enter
	on enter
	on enter
	on enter
	on enter
	on enter
	on enter
		"reputation: Bounty (Disguised)" <?= -1000
		log "Minor People" "Geryon" `Geryon turned out to be a pirate himself. I knew there was something rotten about him.`
		conversation
			scene "thumbnail/Becca scavenger"
			`You receive a hail from Geryon: "The time has come for me to take out the trash." The <npc> targets you with its weapons!`
	npc
		government "Pirate"
		system
			distance 1 2
		personality plunders harvests
		fleet
			names "pirate"
			cargo 0
			variant
				"Rancor (Berserker)"
	npc
		government "Pirate"
		system
			distance 3 4
		personality plunders harvests
		fleet
			names "pirate"
			cargo 0
			variant
				"Berserker (Strike Limit Break)"
	npc
		government "Pirate"
		system
			distance 5 6
		personality plunders harvests
		fleet
			names "pirate"
			cargo 0
			variant
				"Fury (Bomber Limit Break)"
	npc
		government "Pirate"
		system destination
		personality plunders harvests
		fleet
			names "pirate"
			cargo 0
			variant
				"Modified Argosy (Stinger)"
	npc accompany save
		government "Bounty (Disguised)"
		personality target waiting plunders harvests
		ship "Garbage Scow (Heavy)" "Venomous Manticore"



mission "Midnight Expansion: Add Rukh"
	landing
	invisible
	on offer
		event "add rukh"
		fail

event "add rukh"
	shipyard "Dirt Belt Pirates"
		add "Rukh (Modified Blaster)"
	fleet "pirate raid"
		add variant 1
			"Rukh"
	fleet "pirate raid (rivals)"
		add variant 1
			"Rukh"
	fleet "Large Dirt Belt Pirates"
		add variant 1
			"Rukh"
		add variant 1
			"Rukh (Turbo Blaster)"
	fleet "Large Independent"
		add variant 1
			"Rukh"
	fleet "Bounty Hunters"
		add variant 1
			"Rukh (Heavy)"
	fleet "Bounty Hunter (licensed)"
		add variant 1
			"Rukh (Heavy)"
	fleet "Hired Guns"
		add variant 1
			"Rukh (Heavy)"
			"Firebird (Laser)" 2

mission "Midnight Expansion: FW Prisoner Parole Add On"
	landing
	invisible
	source "Deep"
	destination "New Tibet"
	deadline 7
	to offer
		has "Liberate Kornephoros: done"
		not "FW Prisoner Parole: done"
	to fail
		or
			has "FW Prisoner Parole: aborted"
			has "FW Prisoner Parole: failed"
			has "FW Prisoner Parole: done"
	on enter
		dialog `You are hailed by a pirate ship: "I heard you're transporting some navy scum. You can all die together!"`
	npc 
		to spawn
			"ship: Medium Warship" + "ship: Heavy Warship" + "ship: Utility" + "ship: Heavy Freighter" > 1
		government "Pirate"
		system destination
		personality waiting staying vindictive
		fleet "Small Dirt Belt Pirates" 2
	npc 
		government "Pirate"
		system destination
		personality waiting staying vindictive
		fleet "Small Dirt Belt Pirates" 2
	npc 
		government "Pirate"
		system destination
		personality coward
		fleet "Small Dirt Belt Pirates" 2
	npc 
		government "Pirate"
		personality waiting vindictive
		ship "Rukh (Turbo)" "Red Death"

mission "Midnight Expansion: Rukh Blueprints"
	minor
	name "Rukh Blueprints"
	description "Search <destination> for the blueprints of the Rukh." 
	source
		attributes "frontier"
		not attributes "uninhabited"
	destination Hope
	to offer
		"combat rating" > 600
		random < 70
	on offer
		conversation
			scene "effect/blood"
			`When you enter the spaceport bar you notice the smell of blood in the air. The bottles behind the bar are smashed, their contents still leaking onto the floor. The bar counter and several overturned tables are riddled with bullet holes. Behind them, dead bodies lay on the floor. It seems like that smart thing to do is flee, but before you do, you hear faint wheezing from a corner booth.`
			choice
				`	(Investigate the sound.)`
					goto investigate
				`	(Flee.)`
			scene "outfit/attention"
			`	Whoever shot this place up did so recently. You decide to ignore the sound and flee before getting caught up in whatever trouble caused this mess.`
				decline
			label investigate
			scene "outfit/unknown"
			`	An old man lies bleeding on the floor. His breathing is shallow, but he's still alive. When you approach he gasps, "Those bastards... wanted the Rukh blueprints... Wei shipyards... Hope..." He twitches a few times then is still, his breathing silenced. The sound of sirens can be heard in the distance.`
			choice
				`	(Wait for the authorities.)`
				`	(Leave.)`
					goto leave
			action
				set "rukh blueprints slow to follow"
			`	You don't have to wait long for the local police to arrive. After being detained overnight for a lengthy interrogation, they determine that you weren't involved in the shooting and let you go free.`
			``
			label leave
			scene "thumbnail/Becca warbird"
			`	The Rukh is an old warship once manufactured at the Wei shipyards on Hope.`
			choice
				`	(Look for the blueprints.)`
					goto end
				`	(Don't get involved.)`
			scene "outfit/attention"
			`	Someone wanted the blueprints badly enough to kill everyone at the bar. This seems dangerous and you want no part of it. You decide not to look into the whereabouts of the Rukh blueprints.`
				decline
			label end
			scene "planet/ice2"
			`	You've decided to head for <destination> and search for the Rukh blueprints. Before heading out you prepare some gear for the excavation.`
				accept
	on decline
		event "add marauder rukh" 30
	on enter
		dialog
			`You receive a hail from another ship: "Did the old man tell you something? I suppose it doesn't matter. You'll be joining him in the afterlife!`
				to display
					not "rukh blueprints slow to follow"
			`Dealing with the authorities took a considerable amount of time. You'd better hurry to <planet>.`
				to display
					has "rukh blueprints slow to follow"
	npc
		to spawn
			not "rukh blueprints slow to follow"
			"ships: Medium Warship" + "ships: Heavy Warship" + "ships: Utility" + "ships: Heavy Freighter" > 1
		government "Bounty Hunter"
		personality nemesis disables waiting plunders
		fleet "Bounty Hunters"
	npc
		to spawn
			not "rukh blueprints slow to follow"
			"ships: Medium Warship" + "ships: Heavy Warship" + "ships: Utility" + "ships: Heavy Freighter" > 2
		government "Bounty Hunter"
		personality nemesis disables waiting plunders
		fleet "Bounty Hunters"
	npc
		to spawn
			not "rukh blueprints slow to follow"
			"ships: Medium Warship" + "ships: Heavy Warship" + "ships: Utility" + "ships: Heavy Freighter" > 3
		government "Bounty Hunter"
		personality nemesis disables waiting plunders
		fleet "Bounty Hunters"
	npc
		to spawn
			not "rukh blueprints slow to follow"
		government "Bounty Hunter"
		personality nemesis disables waiting plunders
		ship "Rukh (Energy Cannons)" "Rain Dancer"
	on complete
		event "add marauder rukh"
		conversation
			scene "scene/scene-empty box"
			branch slow
				has "rukh blueprints slow to follow"
			`	Someone sent bounty hunters to slow down anyone who might have gotten information from the old man. So it isn't too surprising that after spending all day searching the ruins of the Wei shipyards, you haven't found any blueprints. If they were here, they've already been plundered.`
				accept
			label slow
			action
				clear "rukh blueprints slow to follow"
			`	The authorities on <origin> held you back for a significant amount of time. So it isn't too surprising that after spending all day searching the ruins of the Wei shipyards, you haven't found any blueprints. If they were here, they've already been plundered.`

event "add marauder rukh"
	fleet "Marauder Independent"
		add variant 2
			"Marauder Rukh"
		add variant 2
			"Marauder Rukh (Inferno Rocket)"
		add variant 2
			"Marauder Rukh (Heavy)"
	fleet "Marauder Bounty (Disguised)"
		add variant 2
			"Marauder Rukh"
		add variant 2
			"Marauder Rukh (Inferno Rocket)"
		add variant 2
			"Marauder Rukh (Heavy)"
	fleet "Marauder Independent (Killable)"
		add variant 2
			"Marauder Rukh"
		add variant 2
			"Marauder Rukh (Inferno Rocket)"
		add variant 2
			"Marauder Rukh (Heavy)"
	fleet "Marauder III"
		add variant 1
			"Marauder Rukh"
		add variant 1
			"Marauder Rukh (Inferno Rocket)"
		add variant 1
			"Marauder Rukh (Heavy)"
	fleet "Marauder fleet IV"
		add variant 3
			"Marauder Rukh"
			"Marauder Raven"
			"Marauder Quicksilver"
		add variant 3
			"Marauder Rukh (Inferno Rocket)"
			"Marauder Raven"
			"Marauder Quicksilver"
		add variant 3
			"Marauder Rukh (Heavy)"
			"Marauder Raven"
			"Marauder Quicksilver"
	fleet "Marauder fleet V"
		add variant 2
			"Marauder Rukh"
			"Marauder Raven"
			"Marauder Quicksilver"
		add variant 2
			"Marauder Rukh (Inferno Rocket)"
			"Marauder Raven"
			"Marauder Quicksilver"
		add variant 2
			"Marauder Rukh (Heavy)"
			"Marauder Raven"
			"Marauder Quicksilver"
	fleet "Marauder fleet VI"
		add variant 1
			"Marauder Rukh"
			"Marauder Raven"
			"Marauder Quicksilver"
		add variant 1
			"Marauder Rukh (Inferno Rocket)"
			"Marauder Raven"
			"Marauder Quicksilver"
		add variant 1
			"Marauder Rukh (Heavy)"
			"Marauder Raven"
			"Marauder Quicksilver"



mission "Midnight Scum & Villainy 1A"
	minor
	deadline
	name "Millennium Eagle"
	description "The captain of the Millennium Eagle asked you to escort them safely into a dangerous region of space to reach <destination> by <date>."
	source
		attributes "north"
		not attributes "pirate"
		not attributes "station"
	destination Sunracer
	to offer
		has "main plot completed"
		not "Midnight Scum & Villainy 1B: active"
		not "Midnight Scum & Villainy 1B: done"
		not "Midnight Scum & Villainy 1B: failed"
		random < 70 - ( "Randomize Midnight Scum & Villainy 1A" * 65 )
	on offer
		conversation
			`A freighter captain approaches you. Gesturing at your ship, he says, "If that's the <ship>, then you must be Captain <first> <last>. I'm organizing a convoy through the Northern passage to reach <destination> by <date>, and you're welcome to join us."`
			choice
				`	"Sure, there's safety in numbers."`
				`	"Sorry, I'm headed in a different direction."`
					goto refuse
			`	"My name's Jon Silo, captain of the Millennium Eagle. Truth be told, some of the other captains who'll be joing us thought you'd be unwilling to take part in the convoy. I'm glad they were wrong. See you in orbit." Jon leaves to make preparations for launch.`
				accept
			label refuse
			branch refuse2
				random < 75
			`	"That's unfortunate. I guess having a war hero accompany us was too much to hope for."`
				defer
			label refuse2
			branch refuse3
				random < 66
			`	"That's too bad. I suppose having a war hero join us just wasn't in the cards."`
				defer
			label refuse3
			branch refuse4
				random < 50
			`	"That's what I was afraid of. Some of the others said a war hero wouldn't want to join us. I guess they were right."`
				defer
			label refuse4
			`	"Suit yourself. I guess a war hero doesn't need to join merchant convoys."`
				defer
	on defer
		set "Randomize Midnight Scum & Villainy 1A"
	on enter
		conversation
			scene "thumbnail/AESmisc proto_freighter"
			`Jon sends a hail asking everyone to check in. You notice his ship is an unusual freighter. According to the scanner database it's a Modified Cargo Star, an old design exclusively used by Starwell Shipping Corporation before they were bought out by the Syndicate.`
			scene "thumbnail/hauler i"
			`	"Farm Boy, checking in."`
			scene "thumbnail/freighter"
			`	"Gold Idol, checking in."`
			scene "thumbnail/star barge"
			`	"Astro Tech, checking in."`
			choice
				`	"<ship>, checking in."`
			`	"Stay together everyone. Let's all get to <planet> in one piece."`
	npc
		government Pirate
		system
			distance 1 2
		personality plunders harvests coward
			confusion 20
		fleet "pirate raid"
	npc
		government Pirate
		system
			distance 3 4
		personality plunders harvests coward
			confusion 20
		fleet "pirate raid"
	npc accompany save
		government Merchant
		personality target launching timid
			confusion 30
		"cargo settings"
			cargo 6
		ship "Modified Cargo Star (Smuggler)" "Millennium Eagle"
		ship "Hauler" "Farm Boy"
		ship "Freighter" "Gold Idol"
		ship "Star Barge" "Astro Tech"
	on fail
		dialog "[MISSION FAILED] Not all of the ships in the convoy made it to their destination. If life were a game, you could load a save file and try again."
	on visit
		dialog "One or more ships from the convoy haven't arrived yet. Get back out there and make sure they're safe!"
	on complete
		payment 500000
		dialog "The starship captains pool together <payment> and give it to you for helping them to arrive safely on <planet>."

mission "Midnight Scum & Villainy 1B"
	minor
	deadline
	name "Tomboy Princess"
	description "The captain of the Tomboy Princess asked you to escort them safely into a dangerous region of space to reach <destination> by <date>."
	source
		attributes "paradise"
		not attributes "station"
	destination Sunracer
	to offer
		has "main plot completed"
		not "Midnight Scum & Villainy 1A: active"
		not "Midnight Scum & Villainy 1A: done"
		not "Midnight Scum & Villainy 1A: failed"
		random < 70 - ( "Randomize Midnight Scum & Villainy 1B" * 65 )
	on offer
		conversation
			`A transport captain approaches you. Gesturing at your ship, she says, "If that's the <ship>, then you must be Captain <first> <last>. I'm traveling through the Northern passage to reach <destination> by <date>, and would like for you to escort us."`
			choice
				`	"Sure, there's safety in numbers."`
				`	"Sorry, I'm headed in a different direction."`
					goto refuse
			`	"My name's Lia Skystrider, captain of the Tomboy Princess. Truth be told, I wasn't certain a war hero would be willing to take on a civilian escort job. I'm glad I was wrong. See you in orbit." Lia leaves to make preparations for launch.`
				accept
			label refuse
			branch refuse2
				random < 75
			`	"That's unfortunate. I guess having a war hero accompany us was too much to hope for."`
				defer
			label refuse2
			branch refuse3
				random < 66
			`	"That's too bad. I suppose having a war hero join us just wasn't in the cards."`
				defer
			label refuse3
			branch refuse4
				random < 50
			`	"That's what I was afraid of. I guess a war hero wouldn't be interested in a civilian escort job."`
				defer
			label refuse4
			`	"Suit yourself. I guess a war hero doesn't need to take on civilan escort work."`
				defer
	on defer
		set "Randomize Midnight Scum & Villainy 1B"
	on enter
		conversation
			scene "thumbnail/star queen"
			`You receive a hail from Lia: "The last few times I took this route, pirates attacked. Watch out for a particularly ugly heavy warship that's shaped like a star."`
	npc
		government Pirate
		system
			distance 1 2
		personality plunders harvests coward
			confusion 20
		fleet "pirate raid"
	npc
		government Pirate
		system
			distance 3 4
		personality plunders harvests coward
			confusion 20
		fleet "pirate raid"
	npc accompany save
		government Merchant
		personality target launching timid
			confusion 30
		ship "Star Queen" "Tomboy Princess"
	on fail
		dialog "[MISSION FAILED] The Tomboy Princess was destroyed. If life were a game, you could load a save file and try again."
	on visit
		dialog "The Tomboy Princess hasn't arrived yet. Get back out there and make sure they're safe!"
	on complete
		payment 500000
		dialog "Lia gives you <payment> for helping the Tomboy Princess arrive safely on <planet>."

mission "Midnight Scum & Villainy 2"
	minor
	deadline 14 
	name "Scum & Villainy"
	description "A heavy warship named Scum & Villainy has been preying on merchant ships near <system>. Find it and put a stop to their raids. Return to <destination> for payment. (3,000,000 credits)"
	source Sunracer
	to offer
		or
			has "Midnight Scum & Villainy 1A: done"
			has "Midnight Scum & Villainy 1B: done"
	on offer
		set "Midnight Scum & Villainy 2 patched"
		conversation
			branch lia
				has "Midnight Scum & Villainy 1B: done"
			`As you are about to part ways with Jon and the other captains, a woman shouts "That star shaped ship might be the one! That's just ugly enough to be the ship that's been leading the pirate raiders!" She points an accusatory finger at Jon. "You're the captain of that ship aren't you!?!"`
			`	Jon shrugs. "Listen lady, I've been with a merchant convoy that barely escaped pirates before arriving here. These other captains can vouch for me." The other captains nod in support.`
			`	But the woman is not dissuaded. "How do we know you weren't collaborating with those pirates?"`
			choice
				`	"Maybe there's something on the job boards about that ship."`
					goto board
				`	(Walk away from this.)`
			`	You try to slip away unnoticed from this argument, but Jon calls out to you. "Hey Captain <last>, you're a respectable war hero. Can you convince her I'm innocent?" There's one way to find out...`
			choice
				`	"Maybe there's something on the job boards about that ship."`
			label board
			scene "thumbnail/AESmisc bulwark"
			`	You, Jon, and the woman search the job board for bounties. After a while, you find a post that may be related. "A heavy warship named Scum & Villainy has been preying on merchant ships near <system>. Find it and put a stop to their raids. Return to <destination> for payment. (3,000,000 credits)"`
			`	"Three million! I could pay off my debt with that." Jon looks to you. "Captain <last>, would you be willing to team up with me on this?"`
			`	"Hold on!" The woman interrupts. "Listen buster, I'm not letting you off the hook just yet."`
			`	"Well maybe you should tag along and see for yourself." But Jon's sarcastic reply doesn't make her back down.`
			`	"I think I'll do that." The woman turns to you. "He said you're a war hero? My name is Lia Skystrider. I'll be joining in on this expedition. And I expect a fair share of the reward money when we bring this pirate to justice." She glances at Jon, who smirks and rolls his eyes while shaking his head.`
			choice
				`	"I'm Captain <first> <last>. We'll all split the reward evenly."`
					accept
				`	"Sorry, I'm not interested. Leave me out of this."`
					decline
			label lia
			scene "thumbnail/AESmisc proto_freighter"
			`You are about to part ways with Lia when she gasps, "I think that's the ship. Look <first>, at that star shaped ship!" That's a strange looking freighter. Lia rushes off towards that ship's landing pad.`
			choice
				`	(Follow Lia.)`
				`	(Abandon Lia.)`
					decline
			`When you arrive, Lia is accusing the ship's captain of being a pirate. He defends himself saying, "Listen lady, I've been with a merchant convoy that barely escaped pirates before arriving here. These other captains can vouch for me." Several other freighter captains nod in support.`
			`	But Lia is not dissuaded. "How do we know you weren't collaborating with those pirates?"`
			choice
				`	"Maybe there's something on the job boards about the star shaped pirate ship."`
					goto boardlia
				`	(Walk away from this.)`
			`	You try to slip away unnoticed from this argument, but Lia calls out to you. "Hey Captain <last>, you're a respectable war hero. Do you think he's a pirate?" There's one way to find out...`
			choice
				`	"Maybe there's something on the job boards about the star shaped pirate ship."`
			label boardlia
			scene "thumbnail/AESmisc bulwark"
			`	You, Lia, and the accused man search the job board for bounties. After a while, you find a post that may be related. "A heavy warship named Scum & Villainy has been preying on merchant ships near <system>. Find it and put a stop to their raids. Return to <destination> for payment. (3,000,000 credits)"`
			`	"Three million! I could pay off my debt with that." The man looks to you. "She said you're a war hero? My name's Jon Silo. Would you be willing to team up with me on this?"`
			`	"Hold on!" Lia interrupts. "Listen buster, I'm not letting you off the hook just yet."`
			`	"Well maybe you should tag along and see for yourself." But Jon's sarcastic reply doesn't make her back down.`
			`	"I think I'll do that." Lia turns to you. "I'll be joining in on this expedition. Of course I expect a fair share of the reward money when we bring this pirate to justice." She glances at Jon, who smirks and rolls his eyes while shaking his head.`
			choice
				`	"I'm Captain <first> <last>. We'll all split the reward evenly."`
					accept
				`	"Sorry, I'm not interested. Leave me out of this."`
					decline
	on enter Cardax
		conversation
			`Cardax is a major crossroads in the Northern Passage, so it's no wonder that you find the Scum & Villainy here.`
			`	Jon remarks, "You see now? My ship isn't the one leading pirate raids. It was that Protector."`
			choice
				`	"That's no Protector!"`
			scene "thumbnail/AESmisc bulwark"
			`	Lia laments, "Whatever it is, I have a bad feeling about this..."`
			`	It appears to be a Protector so heavily modified that your ship's database identifies it as a "Wretched Hive", a rare variant even among pirate Marauders.`
	npc accompany save
		government Merchant
		personality target escort timid appeasing
			confusion 30
		ship "Modified Cargo Star (Smuggler)" "Millennium Eagle"
		ship "Star Queen" "Tomboy Princess"
	npc
		government Bounty
		system Cardax
		personality waiting staying plunders
			confusion 10
		fleet
			names "pirate"
			cargo 1
			variant
				"Marauder Manta"
				"Marauder Splinter"
				"Marauder Quicksilver"
				"Marauder Quicksilver (Weapons)"
				"Marauder Quicksilver (Engines)"
				"Pirate Drone" 7
	npc kill
		government Bounty
		system Cardax
		personality target waiting staying plunders
			confusion 10
		ship "Wretched Hive" "Scum & Villainy"
		dialog "The Scum & Villainy has been destroyed. Return to <destination> to collect the reward."
	on fail
		dialog "[MISSION FAILED] Either one or both of your fellow captains was lost during this mission or too much time passed and the Scum & Villainy escaped. If life were a game, you could load a save file and try again."
	on complete
		payment 1000000
		clear "Midnight Scum & Villainy 2 patched"
		log "People" "Jon Silo" `Captain of the Millennium Eagle, an old Starwellian freighter making cargo runs through the Northern Passage. He joined you on a bounty hunt for the Wretched Hive known as "Scum & Villainy".`
		log "People" "Lia Skystrider" `Captain of the Tomboy Princess, a Star Queen ferrying passengers between the Paradise worlds and the core. She joined you on a bounty hunt for the Wretched Hive known as "Scum & Villainy".`
		conversation
			scene "thumbnail/AESmisc proto_freighter"
			`"The Millennium Eagle isn't a warship, it's a classic Starwellian freighter from before the Syndicate..." Jon was boasting about his ship to Lia when you find them at the spaceport.`
			`	She waves to you, "Hi <first>, thanks for your help. Maybe travel through the Northern Passage will be a little safer now." Having collected your share of the three million credit reward, you say goodbye to both of them.`

mission "Midnight Scum & Villainy 2 Patch"
	landing
	invisible
	to offer
		has "Midnight Scum & Villainy 2: failed"
		not "Midnight Scum & Villainy 2 patched"
	on offer
		clear "Midnight Scum & Villainy 2: offered"
		clear "Midnight Scum & Villainy 2: failed" 
		fail

mission "Midnight Venomous Fang 1"
	minor
	name "Millennium Eagle"
	description "The Millennium Eagle hasn't returned from its last voyage. Lia is worried that pirates may have attacked Jon's ship. Search the pirate planets in the north for information."
	source
		attributes "paradise"
		not attributes "station"
	destination "Haven"
	stopover "Zenith"
	stopover "Freedom"
	to offer
		has "Midnight Scum & Villainy 2: done"
		random < 5
	on offer
		conversation
			scene "thumbnail/star queen"
			`You notice the Tomboy Princess is docked at the spaceport. Lia, the Star Queen captain who worked with you to track down the Scum & Villainy, must be here. Meet her again?`
			choice
				`	(Meet Lia.)`
				`	(I'm busy with other things.)`
					defer
			scene "thumbnail/AESmisc proto_freighter"
			`	You find Lia trying to hire crew members at the space port. "Hi <first>! I'm trying to form a rescue party to search for Jon, but no one wants to ride a Star Queen into pirate territory." Jon Silo is the captain of the Modified Cargo Star who teamed up with you and Lia to hunt down the Scum & Villainy.`
			choice
				`	"Jon's missing?"`
				`	"Pirate territory?"`
			`	"I was supposed to meet Jon after his last voyage, a delivery of medicine to Freedom and food to Zenith. But he hasn't returned and I'm worried he might have been attacked by the pirates." Freedom and Zenith are both pirate worlds. It would be more surprising if the pirates didn't attack him.`
			choice
				`	"I could go have a look."`
				`	"He's probably dead now."`
					goto refuse
			`	"Thank you <first>. Stay safe out there." If you don't find anything on Freedom or Zenith, it might be worthwhile to check Haven as well.`
				accept
			label refuse
			`	"I refuse to believe that!" Lia is frustrated by your response. "I won't give up until I'm certain." She leaves to search for Jon on her own.`
				decline
	on stopover
		dialog "Although Jon didn't have a delivery there, it might be worthwhile to also check <destination> for information."
	on visit
		dialog "Jon didn't have any deliveries here. Check Freedom and Zenith first."

mission "Midnight Venomous Fang 1a"
	landing
	invisible
	source "Freedom"
	to offer
		has "Midnight Venomous Fang 1: active"
	on offer
		dialog "After asking around the spaceport, you learn that Jon made his delivery of medicine on time. The locals have nothing else to add."
	on accept
		fail

mission "Midnight Venomous Fang 1b"
	landing
	invisible
	source "Zenith"
	to offer
		has "Midnight Venomous Fang 1: active"
	on offer
		dialog "After asking around the spaceport, you learn that Jon made his delivery of food on time. The locals have nothing else to add."
	on accept
		fail

mission "Midnight Venomous Fang 2"
	name "Venomous Fang"
	description "The Venomous Fang was hired to eliminate the Millennium Eagle. Search for them in the string of uninhabited systems connecting the North to the Core. Head to <destination> when done."
	source "Haven"
	destination "Farpoint"
	to offer
		has "Midnight Venomous Fang 1: done"
	on offer
		conversation
			scene "thumbnail/AESmisc proto_freighter"
			`Your search of Freedom and Zenith didn't reveal any information about Jon's whereabouts. Searching the spaceport on Haven, you hear some disturbing rumors. The Venomous Fang, a bounty hunter ship, was hired by a pirate warlord to track down the Millennium Eagle. It seems Jon dumped some of their contraband when a Navy Gunboat started following him. Both ships are probably somewhere in the Northern Passage, the string of uninhabited systems connecting the North to the Core. Hopefully, you can find them in time.`
				accept
	on enter "Tortor"
		conversation
			scene "thumbnail/AESmisc hydra"
			`You find the Venomous Fang. It's a Leviathan so heavily modified that your ship's computer registers it as an Ogopogo instead. Nearby, the Millennium Eagle sits disabled, an easy target for destruction...`
	npc evade
		government "Bounty Hunter"
		system Tortor
		personality target waiting staying vindictive heroic
			confusion 10
		ship "Ogopogo" "Venomous Fang"
		ship "Combat Drone" "Poison Fang"
		ship "Combat Drone" "Death Fang"
	npc assist save accompany
		government "Merchant"
		system Tortor
		personality target waiting derelict timid
		ship "Modified Cargo Star" "Millennium Eagle"
		dialog `Jon greets you at the air lock. "Thanks! Let's head over to Farpoint before we run into more pirates."`
	on complete
		payment 150000
		conversation
			scene "thumbnail/star queen"
			`When you arrive at Farpoint, you find the Tomboy Princess refueling. Jon thanks you for the rescue and greets Lia. "I'm glad you're both safe" she says. The three of you celebrate at the spaceport bar, where you manage to win <payment> in a few card games before returning to your ship.`

mission "Midnight Modified Cargo Star"
	invisible
	minor
	source
		government "Syndicate"
		not attributes "shipyard" "uninhabited" "station"
	to offer
		"credits" > 7022000
		has "Midnight Venomous Fang 2: done"
		or
			and
				not "Randomize Midnight Modified Cargo Star"
				random < 50
			and
				has "Randomize Midnight Modified Cargo Star"
				random < 1
	on offer
		conversation
			scene "thumbnail/AESmisc proto_freighter"
			`You notice someone trying to sell a used ship, a Modified Cargo Star.`
			choice
				`	"Tell me more about this ship."`
				`	"Not interested in buying a ship right now."`
					defer

			`	The seller says "The Cargo Star was a proprietary freighter used by Starwell Shipping Corporation before it was bought out by the Syndicate in a hostile corporate takeover. Many of the technologies and design principles from this ship can be found in the modern designs of Syndicate Shipyards. Most Cargo Stars that survived the Alpha Wars did so by having extensive modifications made to strengthen their hull, shields, and weapon capacity. The price is 7,022,000."`
			choice
				`	"Sounds good. I'll buy it!`
				`	"That's way too much. I'll pay half that."`
					goto negotiate
				`	"I'm not interested."`
					defer
				`	"My gun says I can take this ship for free."`
					goto shootout

			label "purchase"
			action
				payment -7022000
				give ship "Modified Cargo Star"
			`	"Thank you for your purchase!"`
				decline

			label negotiate
			branch "deal"
				random < 50
			`	"Sorry, I can't budge on the price."`
			choice
				`	"Alright. I'll buy it.`
					goto purchase
				`	"That's way too much. I'm not interested."`
					defer
				`	"My gun says I can take this ship for free."`
					goto shootout

			label "deal"
			`	"How about we meet halfway? 5,266,500 credits."`
			choice
				`	"It's a deal. I'll buy it!`
				`	"That's still too much. I'm not interested."`
					defer
				`	"My gun says I can take this ship for free."`
					goto shootout

			action
				payment -5266500
				give ship "Modified Cargo Star"
			`	"Thank you for your purchase!"`
				decline

			label shootout
			branch "victory"
				random < ( "flagship required crew" - 22 )

			`	You try to take the ship by force, but die during the shootout.`
				die

			label victory
			`	You and your crew manage to overpower the owner's crew and steal the ship!`
				accept

	on defer
		set "Randomize Midnight Modified Cargo Star"

	on accept
		"reputation: Syndicate" <?= -1000
		"reputation: Merchant" <?= -1000
		give ship "Modified Cargo Star"
		clear "Randomize Midnight Modified Cargo Star"

	on enter
		dialog `Looks like the authorities got wind of you pirating the Modified Cargo Star...`

	npc kill
		government "Syndicate"
		personality waiting staying vindictive heroic
		fleet "Large Syndicate"
		fleet "Small Syndicate" 2
